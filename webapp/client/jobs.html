<template name="jobs">
  <div class="container">
    <h1>Jobs monitor</h1>

    {{> reloadGenesCollection}}

    {{! TODO: figure out a place to put this}}
    <!-- {{> jobsHelp}} -->
  </div>
</template>

<template name="reloadGenesCollection">
  <div id="reload-genes-collection" class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">Reload genes collection jobs</div>
    <div class="panel-body">
      <p>Upload a new gene definition file or insert a file from a URL.</p>
      {{> uploadNewFiles}}

      {{#unless count getJobs}}
        <p>You have never reloaded the genes collection</p>
      {{/unless}}
    </div>

    {{#if count getJobs}}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Status</th>
            <th>Created date</th>
            <th>File name</th>
            <th>Actions/Output</th>
          </tr>
        </thead>
        <tbody>
          {{#each getJobs}}
            {{> jobRow}}
          {{/each}}
        </tbody>
      </table>
    {{/if}}
  </div>
</template>

<template name="uploadNewFiles">
  {{! NOTE: this is pulled almost directly from Wrangler}}
  <div class="well insert-file-well">
    <div class="row">
      {{! upload local files}}
      <div class="col-md-6 insert-file-button">
        <span class="btn btn-default btn-file fill-width">
          Upload local files
          <input id="upload-files-input" type="file" multiple>
        </span>
      </div>

      {{! add from the web}}
      <div class="col-md-6 insert-file-button">
        <form id="add-from-web-form">
          <div class="input-group">
            <input name="urlInput" type="text" class="form-control"
                placeholder="Enter URL">
            <span class="input-group-btn">
              <button class="btn btn-default" type="submit">
                Add
              </button>
            </span>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<!-- <template name="runJobs">
  <div class="well">
    <div class="row">
      <span id="checkGeneExpression" class="col-sm-6 btn btn-default btn-file">
        Check gene exprssion
      </span>

      <span id="convertToExpression2" class="col-sm-6 btn btn-default btn-file">
        Convert gene_expression to expression2
      </span>
    </div>
  </div>
</template> -->

<template name="jobRow">
  <tr>
    <th scope="row" class={{status}}>{{status}}</th>
    <td>{{sinceDate}}</td>
    <td>{{args.blob_name}}</td>
    <td>
      {{#if compare status "creating"}}
        <button class="btn btn-xs btn-primary
                {{#if blobStored}}run-job{{else}}disabled{{/if}}"
            title="{{#unless blobStored}}File not uploaded{{/unless}}">
          <span class="glyphicon glyphicon-thumbs-up"></span>
          Start
        </button>

        <button class="btn btn-xs btn-warning delete-job">
          <span class="glyphicon glyphicon-trash"></span>
          Delete
        </button>
      {{/if}}

      {{#if compare status "waiting"}}
      <button class="btn btn-xs btn-warning cancel-job">
        <span class="glyphicon glyphicon-cancel"></span>
        Cancel
      </button>
      {{/if}}

      {{#if waitingOrCreating}}

      {{else}}
        {{#if compare status "running"}}
          running...
        {{/if}}

        {{#if compare status "error"}}
          {{#if stack_trace}}
            Stack trace: <br />
            <div class="sometimes-horizontal-scroll">
              {{#each stackTraceLines}}
                <samp>{{this}}</samp><br />
              {{/each}}
            </div>
          {{else}}
            Error description: <samp>{{error_description}}</samp>
          {{/if}}
        {{/if}}

        {{#if compare status "done"}}
          <span>Genes created: {{output.genes_created}}</span>
        {{/if}}
      {{/if}}
    </td>
  </tr>
</template>

<template name="jobsHelp">
  <div class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">Jobs help</div>
    <div class="panel-body">
      <p>To schedule a job to be run:</p>
<samp style="white-space: pre;">Jobs.insert({
  name: "ParseWranglerFile",
  args: {
    needed_for_job: "Wow this is cool",
    other_argument: "Hello, JobRunner!",
  },
  user_id: Meteor.userId(),
});
</samp>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {{#each getJobsHelp}}
          <tr>
            <th scope="row">{{name}}</th>
            <td>{{help}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</template>
