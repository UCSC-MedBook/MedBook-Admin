<template name="jobs">
  <div class="container">
    <h1>Jobs monitor</h1>

    {{! TODO: swap these back}}
    {{> addTranscriptMapping}}

    {{> reloadGenesCollection}}

    {{! TODO: figure out a place to put this}}
    <!-- {{> jobsHelp}} -->
  </div>
</template>

<template name="reloadGenesCollection">
  <div id="reload-genes-collection" class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">Reload genes collection</div>
    <div class="panel-body">
      <p>
        Upload a new gene definition file or insert a file from a URL.
      </p>
      <p>
        Note that when you reload the genes collection, all isoform mappings
        have to be reloaded.
      </p>
      {{> uploadNewFiles "ReloadGenesCollection"}}
    </div>

    {{> jobsTable "ReloadGenesCollection"}}
  </div>
</template>

<template name="addTranscriptMapping">
  <div id="add-transcript-mapping" class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">Add transcript mappings to genes collection</div>
    <div class="panel-body">
      <p>
        Upload a new transcript mapping file or insert a file from a URL.
      </p>
      <p>
        These will have to be rerun when you reload the genes collection.
      </p>
      {{> uploadNewFiles "GeneTranscriptMappings"}}
    </div>

    {{> jobsTable "GeneTranscriptMappings"}}
  </div>
</template>

<template name="uploadNewFiles">
  {{! NOTE: this is pulled almost directly from Wrangler}}
  <div class="well insert-file-well">
    <div class="row">
      {{! upload local files}}
      <div class="col-md-6 insert-file-button">
        <span class="btn btn-default btn-file fill-width">
          Upload local files
          <input class="upload-files-input" type="file" multiple>
        </span>
      </div>

      {{! add from the web}}
      <div class="col-md-6 insert-file-button">
        <form class="add-from-web">
          <div class="input-group">
            <input name="urlInput" type="text" class="form-control"
                placeholder="Enter URL">
            <span class="input-group-btn">
              <button class="btn btn-default" type="submit">
                Add
              </button>
            </span>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<template name="jobsTable">
  {{#if length getJobs}}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Status</th>
          <th>Created date</th>
          <th>File name</th>
          <th>Actions/Output</th>
        </tr>
      </thead>
      <tbody>
        {{#each getJobs}}
          {{> jobRow}}
        {{/each}}
      </tbody>
    </table>
  {{else}}
    <div class="panel-body">
      <p>No jobs.</p>
    </div>
  {{/if}}
</template>

<template name="jobRow">
  <tr>
    <th scope="row" class={{status}}>{{status}}</th>
    <td>{{sinceDate}}</td>
    <td>{{args.blob_name}}</td>
    <td>
      {{#if compare status "creating"}}
        <button class="btn btn-xs btn-primary
                {{#if blobStored}}run-job{{else}}disabled{{/if}}"
            title="{{#unless blobStored}}File not fully uploaded{{/unless}}">
          <span class="glyphicon glyphicon-thumbs-up"></span>
          Start
        </button>

        <button class="btn btn-xs btn-warning delete-job">
          <span class="glyphicon glyphicon-trash"></span>
          Delete
        </button>
      {{/if}}

      {{#if compare status "waiting"}}
      <button class="btn btn-xs btn-warning cancel-job">
        <span class="glyphicon glyphicon-cancel"></span>
        Cancel
      </button>
      {{/if}}

      {{#unless waitingOrCreating}}
        {{#if compare status "running"}}
          running...
        {{/if}}

        {{#if compare status "error"}}
          {{#if stack_trace}}
            Stack trace: <br />
            <div class="sometimes-horizontal-scroll">
              {{#each stackTraceLines}}
                <samp>{{this}}</samp><br />
              {{/each}}
            </div>
          {{else}}
            Error description: <samp>{{error_description}}</samp>
          {{/if}}
        {{/if}}

        {{#if compare status "done"}}
          {{! TODO: figure out another way to do this :)}}
          {{#if output.genesCreated}}
            <p>Genes created: {{output.genesCreated}}</p>
          {{/if}}

          {{#if output.transcriptsMapped}}
            <p>Transcripts mapped: {{output.transcriptsMapped}}</p>
          {{/if}}

          {{#if output.unableToMap}}
            <p>Transcripts unable to map (genes don't exist): {{output.unableToMap}}</p>
          {{/if}}
        {{/if}}

        {{#if errorOrDone}}
          <button class="rerun-job btn btn-xs btn-warning">
            <span class="glyphicon glyphicon-refresh"></span>
            Rerun
          </button>
        {{/if}}
      {{/unless}}
    </td>
  </tr>
</template>








<!-- Not used currently -->
<template name="jobsHelp">
  <div class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">Jobs help</div>
    <div class="panel-body">
      <p>To schedule a job to be run:</p>
<samp style="white-space: pre;">Jobs.insert({
  name: "ParseWranglerFile",
  args: {
    needed_for_job: "Wow this is cool",
    other_argument: "Hello, JobRunner!",
  },
  user_id: Meteor.userId(),
});
</samp>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {{#each getJobsHelp}}
          <tr>
            <th scope="row">{{name}}</th>
            <td>{{help}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</template>
